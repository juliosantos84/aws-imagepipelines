name: EtherythingbiigNodeProvisioner
description: Provisions an etherythingbiig node.
schemaVersion: 1.0
# parameters:
#   - SCRIPTS_S3_URL:
#       type: string
#       description: The S3 URL for the scripts asset.
#   - SCRIPTS_S3_BUCKET_NAME:
#       type: string
#       description: The S3 bucket for the scripts asset.
#   - SCRIPTS_S3_OBJECT_KEY:
#       type: string
#       description: The S3 object key for the scripts asset.
phases:
  - name: 'build'
    steps:
      - name: InstallCfnBootstrap
        action: ExecuteBash
        onFailure: Abort
        timeoutSeconds: 60
        maxAttempts: 1
        inputs:
          commands:
            - |
              AWS_ROOT=/opt/aws
              sudo mkdir -p ${AWS_ROOT}
              sudo chown -R ubuntu:users ${AWS_ROOT}
              curl https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-py3-latest.tar.gz --output /tmp/aws-cfn-bootstrap-py3-latest.tar.gz
              tar -xvf /tmp/aws-cfn-bootstrap-py3-latest.tar.gz -C /tmp/
              mv /tmp/aws-cfn-bootstrap-2.0/* ${AWS_ROOT}
              # I hate this, but couldn't pass the right params to the install script
              cd ${AWS_ROOT}
              sudo python3 ${AWS_ROOT}/setup.py install --prefix ${AWS_ROOT} --install-lib /usr/lib/python3.8
              sudo chmod +x ${AWS_ROOT}/bin/*
              sudo ln -s ${AWS_ROOT}/bin/cfn-hup /etc/init.d/cfn-hup
      - name: InstallCommonUtils
        action: ExecuteBash
        onFailure: Abort
        timeoutSeconds: 60
        maxAttempts: 1
        inputs:
          commands:
            - sudo apt update
            - sudo apt install awscli jq unzip -y
      - name: CreateGethUsers
        action: ExecuteBash
        onFailure: Abort
        timeoutSeconds: 30
        maxAttempts: 1
        inputs:
          commands:
            - sudo useradd --no-create-home --shell /bin/false goeth
      - name: InstallGethBinaries
        action: ExecuteBash
        onFailure: Abort
        timeoutSeconds: 30
        maxAttempts: 1
        inputs:
          commands:
          - |
            GETH_VERSION=1.10.8-26675454
            BINARY_NAME=geth-linux-amd64-$GETH_VERSION
            ARCHIVE_NAME=$BINARY_NAME.tar.gz
            curl -L https://gethstore.blob.core.windows.net/builds/$ARCHIVE_NAME --output /tmp/$ARCHIVE_NAME
            sudo tar -xvf /tmp/$ARCHIVE_NAME
            sudo mv ./$BINARY_NAME/geth /usr/local/bin/geth
      - name: InstallGethScripts
        action: ExecuteBash
        onFailure: Abort
        timeoutSeconds: 30
        maxAttempts: 1
        inputs:
          commands:
          - |
            SCRIPTS_S3_URL=${{SCRIPTS_S3_URL}}
            aws s3 cp $SCRIPTS_S3_URL /tmp/scripts.zip
            sudo unzip /tmp/scripts.zip -d /usr/local/bin
            sudo chown goeth:goeth /usr/local/bin/*-goeth-volume.sh
            sudo chmod 755 /usr/local/bin/*-goeth-volume.sh
      - name: InstallGethServices
        action: ExecuteBash
        onFailure: Abort
        timeoutSeconds: 30
        maxAttempts: 1
        inputs:
          commands:
          - |
            SERVICES_S3_URL=${{SERVICES_S3_URL}}
            aws s3 cp $SERVICES_S3_URL /tmp/services.zip
            sudo unzip /tmp/services.zip -d /etc/systemd/system
            sudo systemctl daemon-reload
            
