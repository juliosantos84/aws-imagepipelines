name: GethNodeProvisioner
description: Provisions a geth node.
schemaVersion: 1.0
# parameters:
#   - SCRIPTS_S3_URL:
#       type: string
#       description: The S3 URL for the scripts asset.
#   - SCRIPTS_S3_BUCKET_NAME:
#       type: string
#       description: The S3 bucket for the scripts asset.
#   - SCRIPTS_S3_OBJECT_KEY:
#       type: string
#       description: The S3 object key for the scripts asset.
phases:
  - name: 'build'
    steps:
      - name: CreateUsers
        action: ExecuteBash
        onFailure: Abort
        timeoutSeconds: 30
        maxAttempts: 1
        inputs:
          commands:
            - sudo useradd --no-create-home --shell /bin/false goeth
      - name: InstallBinaries
        action: ExecuteBash
        onFailure: Abort
        timeoutSeconds: 30
        maxAttempts: 1
        inputs:
          commands:
          - |
            GETH_VERSION=1.10.8-26675454
            BINARY_NAME=geth-linux-amd64-$GETH_VERSION
            ARCHIVE_NAME=$BINARY_NAME.tar.gz
            curl -L https://gethstore.blob.core.windows.net/builds/$ARCHIVE_NAME --output /tmp/$ARCHIVE_NAME
            sudo tar -xvf /tmp/$ARCHIVE_NAME
            sudo mv ./$BINARY_NAME/geth /usr/local/bin/geth
      - name: InstallScripts
        action: ExecuteBash
        onFailure: Abort
        timeoutSeconds: 30
        maxAttempts: 1
        inputs:
          commands:
          - |
            SCRIPTS_S3_URL=${{SCRIPTS_S3_URL}}
            UNITS_S3_URL=${{UNITS_S3_URL}}
            aws s3 cp $SCRIPTS_S3_URL /tmp/scripts.zip
            aws s3 cp $UNITS_S3_URL /tmp/scripts.zip
            sudo unzip /tmp/scripts.zip -d /usr/local/bin
      - name: InstallServices
        action: ExecuteBash
        onFailure: Abort
        timeoutSeconds: 30
        maxAttempts: 1
        inputs:
          commands:
          - |
            UNITS_S3_URL=${{UNITS_S3_URL}}
            aws s3 cp $UNITS_S3_URL /tmp/units.zip
            sudo unzip /tmp/units.zip -d /etc/systemd/system
            sudo systemctl daemon-reload
            
